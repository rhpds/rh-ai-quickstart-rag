---
- name: Validate field content repository URL is provided
  ansible.builtin.fail:
    msg: "ocp4_workload_field_content_gitops_repo_url is required but not provided"
  when: ocp4_workload_field_content_gitops_repo_url == "" or ocp4_workload_field_content_gitops_repo_url is not defined

# ===================================================================
# Check for LiteMaaS credentials (optional - passed from AgnosticV)
# ===================================================================
# AgnosticV reads from agnosticd_user_data and passes as workload variables
- name: Check if LiteMaaS credentials are available
  ansible.builtin.set_fact:
    _litemaas_api_url: "{{ ocp4_workload_field_content_litemaas_api_url | default('') }}"
    _litemaas_api_key: "{{ ocp4_workload_field_content_litemaas_api_key | default('') }}"
    _litemaas_model: "{{ ocp4_workload_field_content_litemaas_model | default('granite-3-2-8b-instruct') }}"

- name: Set LiteMaaS availability flag
  ansible.builtin.set_fact:
    _litemaas_available: "{{ _litemaas_api_url != '' and _litemaas_api_key != '' }}"

- name: Debug LiteMaaS credentials status
  ansible.builtin.debug:
    msg: |
      LiteMaaS credentials available: {{ _litemaas_available }}
      API URL: {{ _litemaas_api_url if _litemaas_available else 'not set' }}
      Model: {{ _litemaas_model if _litemaas_available else 'not set' }}

# ===================================================================
# Build Helm values
# ===================================================================
- name: Set deployer values (always included)
  ansible.builtin.set_fact:
    _ocp4_workload_field_content_deployer_values:
      deployer:
        domain: "{{ openshift_cluster_ingress_domain }}"
        apiUrl: "{{ openshift_api_url }}"

- name: Add LiteMaaS credentials to Helm values (if available)
  ansible.builtin.set_fact:
    _ocp4_workload_field_content_litemaas_values:
      litemaas:
        enabled: true
        apiUrl: "{{ _litemaas_api_url }}"
        apiKey: "{{ _litemaas_api_key }}"
        model: "{{ _litemaas_model }}"
  when: _litemaas_available | bool

- name: Set empty LiteMaaS values (if not available)
  ansible.builtin.set_fact:
    _ocp4_workload_field_content_litemaas_values:
      litemaas:
        enabled: false
  when: not (_litemaas_available | bool)

- name: Combine all Helm values
  ansible.builtin.set_fact:
    _ocp4_workload_field_content_all_values: >-
      {{
        ocp4_workload_field_content_helm_values | default({})
        | combine(_ocp4_workload_field_content_deployer_values)
        | combine(_ocp4_workload_field_content_litemaas_values)
      }}

- name: Debug final Helm values
  ansible.builtin.debug:
    msg: "{{ _ocp4_workload_field_content_all_values | to_yaml }}"

# ===================================================================
# Deploy via ArgoCD
# ===================================================================
- name: Create field content ArgoCD application
  kubernetes.core.k8s:
    state: present
    template: application.yaml.j2

- name: Verify ArgoCD application was accepted
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    name: field-content
    namespace: "{{ ocp4_workload_field_content_namespace }}"
  register: argocd_field_content
  retries: 6
  delay: 10
  until:
  - argocd_field_content.resources | length > 0
  failed_when: argocd_field_content.resources | length == 0
