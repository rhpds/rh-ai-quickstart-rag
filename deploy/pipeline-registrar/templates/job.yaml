apiVersion: batch/v1
kind: Job
metadata:
  name: pipeline-registrar
  labels:
    app: pipeline-registrar
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: pipeline-registrar
    spec:
      initContainers:
        - name: wait-for-ingestion-service
          image: "image-registry.openshift-image-registry.svc:5000/openshift/tools:latest"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              url="http://{{ .Values.ingestionService }}/ping"
              echo "Waiting for ingestion pipeline service at $url..."
              until curl -ksf "$url"; do
                echo "Still waiting for $url ..."
                sleep 10
              done
              echo "Ingestion pipeline service is ready"
      containers:
        - name: register-pipelines
          image: "image-registry.openshift-image-registry.svc:5000/openshift/tools:latest"
          command:
            - /bin/bash
            - -c
            - |
              SERVICE="http://{{ .Values.ingestionService }}/add"
              FAILED=0
              TOTAL={{ len .Values.pipelines }}
              COUNT=0

              {{- range $pipeline := .Values.pipelines }}

              COUNT=$((COUNT + 1))
              echo ""
              echo "=== Registering pipeline: {{ $pipeline.name }} ($COUNT/$TOTAL) ==="
              SUCCESS=false
              for attempt in 1 2 3 4 5; do
                HTTP_CODE=$(curl -s -o /tmp/response.txt -w '%{http_code}' -X POST "$SERVICE" \
                  -H 'accept: application/json' \
                  -H 'Content-Type: application/json' \
                  -d '{{ $pipeline.body | toJson }}' || echo "000")

                if [ "$HTTP_CODE" = "200" ]; then
                  echo "Pipeline {{ $pipeline.name }} registered successfully:"
                  cat /tmp/response.txt
                  echo ""
                  SUCCESS=true
                  break
                else
                  echo "Attempt $attempt failed (HTTP $HTTP_CODE), retrying in 10s..."
                  cat /tmp/response.txt 2>/dev/null || true
                  echo ""
                  sleep 10
                fi
              done

              if [ "$SUCCESS" != "true" ]; then
                echo "ERROR: Failed to register pipeline {{ $pipeline.name }} after 5 attempts"
                FAILED=$((FAILED + 1))
              fi

              # Pause between pipelines to avoid race condition
              sleep 5
              {{- end }}

              echo ""
              if [ "$FAILED" -gt 0 ]; then
                echo "ERROR: $FAILED pipeline(s) failed to register"
                exit 1
              fi

              echo "All $TOTAL pipelines registered successfully"
      restartPolicy: Never
