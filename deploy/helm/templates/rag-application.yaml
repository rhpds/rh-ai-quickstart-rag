---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: rag-stack
  namespace: openshift-gitops
  labels:
    demo.redhat.com/application: "rag-quickstart"
  annotations:
    argocd.argoproj.io/sync-wave: "10"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/rh-ai-quickstart/RAG.git
    targetRevision: main
    path: deploy/helm/rag
    helm:
      values: |
        # ===================================================================
        # Global LLM Configuration
        # ===================================================================
        global:
          models:
            {{- if .Values.litemaas.enabled }}
            # Remote LLM from LiteMaaS/MaaS
            remote-llm:
              id: {{ .Values.litemaas.model | quote }}
              url: {{ .Values.litemaas.apiUrl | quote }}
              apiToken: {{ .Values.litemaas.apiKey | quote }}
              enabled: true
            {{- else }}
            # No LLM configured - LiteMaaS not enabled
            # User must provide their own model configuration
            {{- end }}

        # ===================================================================
        # LLM Service Configuration
        # ===================================================================
        {{- if .Values.litemaas.enabled }}
        # Disable local LLM service when using remote LiteMaaS
        llm-service:
          enabled: false
        {{- else }}
        # Local LLM service configuration (user must provide HF token)
        llm-service:
          enabled: false  # Disabled by default - requires GPU and HF token
        {{- end }}

        # ===================================================================
        # Llama Stack Configuration
        # ===================================================================
        llama-stack:
          enabled: true
          secrets:
            # Tavily websearch disabled (no API key)
            TAVILY_SEARCH_API_KEY: ""

        # ===================================================================
        # PostgreSQL Vector Database
        # ===================================================================
        pgvector:
          enabled: {{ .Values.rag.enableDatabase }}
          sampleFileUpload:
            enabled: true
            bucket: documents
            urls:
              - https://raw.githubusercontent.com/rh-ai-quickstart/RAG/refs/heads/main/notebooks/hr/FantaCo-Fabulous-HR-Benefits.pdf
              - https://raw.githubusercontent.com/rh-ai-quickstart/RAG/refs/heads/main/notebooks/legal/FantaCo-Enterprise-Contract-Reviewer-Analyst-Policy-Procedure-Manual.pdf
              - https://raw.githubusercontent.com/rh-ai-quickstart/RAG/refs/heads/main/notebooks/sales/FantaCo-Sales-Operations-Manual.pdf

        # ===================================================================
        # Configure Pipeline
        # ===================================================================
        # Enable MinIO for document storage, disable Notebook (requires DSPA)
        configure-pipeline:
          enabled: true
          notebook:
            enabled: false
          minio:
            secret:
              user: minio_rag_user
              password: minio_rag_password
              host: minio
              port: "9000"
            sampleFileUpload:
              enabled: true
              bucket: documents
              urls:
                - https://raw.githubusercontent.com/rh-ai-quickstart/RAG/refs/heads/main/notebooks/hr/FantaCo-Fabulous-HR-Benefits.pdf
                - https://raw.githubusercontent.com/rh-ai-quickstart/RAG/refs/heads/main/notebooks/legal/FantaCo-Enterprise-Contract-Reviewer-Analyst-Policy-Procedure-Manual.pdf
                - https://raw.githubusercontent.com/rh-ai-quickstart/RAG/refs/heads/main/notebooks/sales/FantaCo-Sales-Operations-Manual.pdf
                - https://raw.githubusercontent.com/rh-ai-quickstart/RAG/refs/heads/main/notebooks/procurement/FantaCo-Procurement.pdf

        # ===================================================================
        # Document Ingestion Pipelines
        # ===================================================================
        # DISABLED - Requires OpenShift AI Data Science Pipelines (DSPA CRD)
        ingestion-pipeline:
          enabled: false
          serviceAccount:
            create: true
            name: rag-pipeline-notebook
          pipelines:
            {{- if has "hr" .Values.rag.sampleData.sources }}
            # HR Documents Pipeline
            hr-pipeline:
              enabled: true
              source: GITHUB
              embedding_model: "all-MiniLM-L6-v2"
              name: "hr-vector-db"
              version: "1.0"
              vector_store_name: "hr-vector-db-v1-0"
              GITHUB:
                url: https://github.com/rh-ai-quickstart/RAG.git
                path: notebooks/hr
                token: auth_token
                branch: main
            {{- end }}

            {{- if has "legal" .Values.rag.sampleData.sources }}
            # Legal Documents Pipeline
            legal-pipeline:
              enabled: true
              source: GITHUB
              embedding_model: "all-MiniLM-L6-v2"
              name: "legal-vector-db"
              version: "1.0"
              vector_store_name: "legal-vector-db-v1-0"
              GITHUB:
                url: https://github.com/rh-ai-quickstart/RAG.git
                path: notebooks/legal
                token: auth_token
                branch: main
            {{- end }}

            {{- if has "sales" .Values.rag.sampleData.sources }}
            # Sales Documents Pipeline
            sales-pipeline:
              enabled: true
              source: GITHUB
              embedding_model: "all-MiniLM-L6-v2"
              name: "sales-vector-db"
              version: "1.0"
              vector_store_name: "sales-vector-db-v1-0"
              GITHUB:
                url: https://github.com/rh-ai-quickstart/RAG.git
                path: notebooks/sales
                token: auth_token
                branch: main
            {{- end }}

            {{- if has "procurement" .Values.rag.sampleData.sources }}
            # Procurement Documents Pipeline
            procurement-pipeline:
              enabled: true
              source: GITHUB
              embedding_model: "all-MiniLM-L6-v2"
              name: "procurement-vector-db"
              version: "1.0"
              vector_store_name: "procurement-vector-db-v1-0"
              GITHUB:
                url: https://github.com/rh-ai-quickstart/RAG.git
                path: notebooks/procurement
                token: auth_token
                branch: main
            {{- end }}

            {{- if has "techsupport" .Values.rag.sampleData.sources }}
            # Tech Support Documents Pipeline
            techsupport-pipeline:
              enabled: true
              source: GITHUB
              embedding_model: "all-MiniLM-L6-v2"
              name: "techsupport-vector-db"
              version: "1.0"
              vector_store_name: "techsupport-vector-db-v1-0"
              GITHUB:
                url: https://github.com/rh-ai-quickstart/RAG.git
                path: notebooks/techsupport
                token: auth_token
                branch: main
            {{- end }}

        # ===================================================================
        # RAG UI Configuration
        # ===================================================================
        replicaCount: 1
        image:
          repository: "quay.io/rh-ai-quickstart/llamastack-dist-ui"
          pullPolicy: "Always"
        env:
          - name: "LLAMA_STACK_ENDPOINT"
            value: "http://llamastack:8321"

        # ===================================================================
        # Suggested Questions for UI
        # ===================================================================
        suggestedQuestions:
          hr-vector-db-v1-0:
            - "What are the health insurance benefits offered?"
            - "How many vacation days do employees get?"
            - "What is the parental leave policy?"
            - "What are the retirement benefits?"
            - "How do I enroll in benefits?"
            - "What is the employee assistance program?"

          legal-vector-db-v1-0:
            - "What are the key contract terms?"
            - "What is the liability clause?"
            - "What are the termination conditions?"
            - "What are the intellectual property rights?"
            - "What is the dispute resolution process?"
            - "What are the compliance requirements?"

          sales-vector-db-v1-0:
            - "What is the sales process?"
            - "How do I qualify leads?"
            - "What are the pricing strategies?"
            - "What is the commission structure?"
            - "How do I handle customer objections?"
            - "What are the territory assignments?"

          procurement-vector-db-v1-0:
            - "What is the procurement process?"
            - "How do I submit a purchase request?"
            - "What are the approval requirements?"
            - "Who are the approved vendors?"
            - "What is the purchasing policy?"
            - "How do I track my order?"

          techsupport-vector-db-v1-0:
            - "How do I install CloudSync on Mac?"
            - "How do I install CloudSync on Windows?"
            - "How do I sync files between devices?"
            - "How do I troubleshoot CloudSync sync issues?"
            - "How do I install Linux on TechGear Pro Laptop?"
            - "Where can I find video drivers for TechGear Pro?"

  destination:
    namespace: {{ .Values.rag.namespace }}
    server: https://kubernetes.default.svc

  syncPolicy:
    automated:
      prune: false
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
