---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "ansible-runner.fullname" . }}
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "ansible-runner.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: {{ .Values.syncWave.job | quote }}
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  {{- if gt (.Values.job.ttlSecondsAfterFinished | int) 0 }}
  ttlSecondsAfterFinished: {{ .Values.job.ttlSecondsAfterFinished }}
  {{- end }}
  template:
    metadata:
      labels:
        {{- include "ansible-runner.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ .Values.serviceAccount.name }}
      restartPolicy: {{ .Values.job.restartPolicy }}
      containers:
      - name: ansible-runner
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        # Cluster information (automatically provided by field content workload)
        - name: CLUSTER_DOMAIN
          value: "{{ .Values.deployer.domain | default "apps.cluster.example.com" }}"
        - name: CLUSTER_API_URL
          value: "{{ .Values.deployer.apiUrl | default "https://api.cluster.example.com:6443" }}"
        - name: ANSIBLE_CONFIG
          value: "/tmp/ansible/ansible.cfg"
        - name: KUBECONFIG
          value: "/tmp/ansible/kubeconfig"
        # Git repository configuration
        - name: GIT_REPO_URL
          value: {{ .Values.ansible.repository.url | quote }}
        - name: GIT_REPO_BRANCH
          value: {{ .Values.ansible.repository.branch | quote }}
        - name: PLAYBOOK_PATH
          value: {{ .Values.ansible.playbook | quote }}
        - name: NAMESPACE
          value: {{ .Values.namespace.name | quote }}
        {{- if .Values.ansible.repository.secretName }}
        # Git credentials (if using private repository)
        - name: GIT_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.ansible.repository.secretName }}
              key: username
        - name: GIT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.ansible.repository.secretName }}
              key: password
        {{- end }}

        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "=== Ansible Runner Job Starting ==="
          echo "Repository: $GIT_REPO_URL"
          echo "Branch: $GIT_REPO_BRANCH"
          echo "Playbook: $PLAYBOOK_PATH"
          echo "Namespace: $NAMESPACE"

          # Create working directory
          mkdir -p /tmp/ansible
          cd /tmp/ansible

          # Install Ansible and required packages
          echo "=== Installing Python packages ==="
          pip install --quiet --upgrade pip
          pip install --quiet -r /config/requirements.txt

          # Install helm (required by showroom role)
          echo "=== Installing Helm ==="
          curl -fsSL https://get.helm.sh/helm-v3.14.0-linux-amd64.tar.gz | tar xz -C /tmp
          mv /tmp/linux-amd64/helm /opt/app-root/bin/
          helm version --short

          # Install required Ansible collections
          echo "=== Installing Ansible collections ==="
          while read collection; do
            [ -z "$collection" ] || ansible-galaxy collection install "$collection" --force
          done < /config/collections.txt

          # Copy Ansible configuration
          cp /config/ansible.cfg /tmp/ansible/
          cp /config/inventory.yaml /tmp/ansible/

          # Create kubeconfig from service account token
          echo "=== Creating kubeconfig ==="
          cat > /tmp/ansible/kubeconfig << 'KUBECONFIG_EOF'
          apiVersion: v1
          kind: Config
          clusters:
          - name: default
            cluster:
              certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              server: https://kubernetes.default.svc
          contexts:
          - name: default
            context:
              cluster: default
              user: default
          current-context: default
          users:
          - name: default
            user:
              tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
          KUBECONFIG_EOF

          # Clone the Git repository with playbooks
          echo "=== Cloning playbook repository ==="
          {{- if .Values.ansible.repository.secretName }}
          git clone --branch ${GIT_REPO_BRANCH} \
            https://${GIT_USERNAME}:${GIT_PASSWORD}@$(echo ${GIT_REPO_URL} | sed 's|https://||') \
            /tmp/ansible/playbooks
          {{- else }}
          git clone --branch ${GIT_REPO_BRANCH} ${GIT_REPO_URL} /tmp/ansible/playbooks
          {{- end }}

          {{- if .Values.ansible.repository.path }}
          cd /tmp/ansible/playbooks/{{ .Values.ansible.repository.path }}
          {{- else }}
          cd /tmp/ansible/playbooks
          {{- end }}

          # Install any additional requirements from the playbook repository
          if [ -f requirements.yml ]; then
            echo "=== Installing requirements.yml ==="
            ansible-galaxy install -r requirements.yml
          fi

          if [ -f requirements.txt ]; then
            echo "=== Installing requirements.txt ==="
            pip install --quiet -r requirements.txt
          fi

          # Prepare extra variables
          EXTRA_VARS="cluster_domain=${CLUSTER_DOMAIN} cluster_api_url=${CLUSTER_API_URL} namespace=${NAMESPACE}"

          {{- range $key, $value := .Values.ansible.extraVars }}
          EXTRA_VARS="$EXTRA_VARS {{ $key }}={{ $value }}"
          {{- end }}

          # Run the playbook
          echo "=== Executing Ansible Playbook ==="
          echo "Playbook: $PLAYBOOK_PATH"
          echo "Extra vars: $EXTRA_VARS"

          ansible-playbook \
            -i /tmp/ansible/inventory.yaml \
            --extra-vars "$EXTRA_VARS" \
            -v \
            ${PLAYBOOK_PATH}

          echo "=== Ansible Runner Job Completed Successfully ==="

        volumeMounts:
        - name: config
          mountPath: /config
          readOnly: true

        resources:
          {{- toYaml .Values.resources | nindent 10 }}

      volumes:
      - name: config
        configMap:
          name: {{ include "ansible-runner.fullname" . }}-config