---
# Generate an SSH keypair
# - Stores public key as an OpenShift secret
# - Sets private key as a fact for use in userinfo
#
# Output variables:
#   - ssh_private_key: The generated private key (use in userinfo)
#   - ssh_public_key: The generated public key

- name: Generate SSH keypair
  community.crypto.openssh_keypair:
    path: "/tmp/ssh_key_{{ ssh_keypair_secret_name }}"
    type: "{{ ssh_keypair_type }}"
    size: "{{ ssh_keypair_size }}"
    comment: "{{ ssh_keypair_comment }}"
    state: present
  register: r_keypair

- name: Read private key
  ansible.builtin.slurp:
    src: "/tmp/ssh_key_{{ ssh_keypair_secret_name }}"
  register: r_private_key

- name: Read public key
  ansible.builtin.slurp:
    src: "/tmp/ssh_key_{{ ssh_keypair_secret_name }}.pub"
  register: r_public_key

- name: Set SSH key facts
  ansible.builtin.set_fact:
    ssh_private_key: "{{ r_private_key.content | b64decode }}"
    ssh_public_key: "{{ r_public_key.content | b64decode | trim }}"

- name: Display keypair info
  ansible.builtin.debug:
    msg:
      - "=== SSH Keypair Generated ==="
      - "Secret name: {{ ssh_keypair_secret_name }}"
      - "Namespace: {{ ssh_keypair_namespace }}"
      - "Key type: {{ ssh_keypair_type }} ({{ ssh_keypair_size }} bits)"

- name: Create secret with public key
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ ssh_keypair_secret_name }}"
        namespace: "{{ ssh_keypair_namespace }}"
        labels:
          app.kubernetes.io/managed-by: ansible
      type: Opaque
      stringData:
        id_rsa.pub: "{{ ssh_public_key }}"

- name: Clean up temporary key files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/ssh_key_{{ ssh_keypair_secret_name }}"
    - "/tmp/ssh_key_{{ ssh_keypair_secret_name }}.pub"

- name: SSH keypair ready
  ansible.builtin.debug:
    msg:
      - "Public key stored in secret: {{ ssh_keypair_namespace }}/{{ ssh_keypair_secret_name }}"
      - "Private key available in variable: ssh_private_key"
