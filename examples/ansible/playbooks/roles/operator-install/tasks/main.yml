---
# Install an operator via OLM and wait for it to be ready
# This demonstrates Ansible's advantage over Helm/Kustomize:
# - Check existing state before acting
# - Wait for resources to be ready
# - Conditional logic
# - Multi-step workflows

# Step 1: Check if operator is already installed
- name: Check if Subscription already exists
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: "{{ install_operator_name }}"
    namespace: "{{ install_operator_namespace }}"
  register: existing_subscription

- name: Set operator already installed fact
  ansible.builtin.set_fact:
    operator_already_installed: >-
      {{ existing_subscription.resources | length > 0 and
         existing_subscription.resources[0].status.currentCSV is defined }}

- name: Operator already installed - skipping
  ansible.builtin.debug:
    msg: "Operator {{ install_operator_name }} is already installed ({{ existing_subscription.resources[0].status.currentCSV }})"
  when: operator_already_installed

# Step 2: Install operator if not already present
- name: Create Subscription for {{ install_operator_name }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: "{{ install_operator_name }}"
        namespace: "{{ install_operator_namespace }}"
        labels:
          demo.redhat.com/application: "{{ install_operator_name }}"
      spec:
        channel: "{{ install_operator_channel }}"
        installPlanApproval: Automatic
        name: "{{ install_operator_name }}"
        source: "{{ install_operator_source }}"
        sourceNamespace: "{{ install_operator_source_namespace }}"
  when: not operator_already_installed

- name: Wait for Subscription to have a currentCSV
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: "{{ install_operator_name }}"
    namespace: "{{ install_operator_namespace }}"
  register: subscription_info
  until: >-
    subscription_info.resources | length > 0 and
    subscription_info.resources[0].status.currentCSV is defined
  retries: "{{ install_wait_retries }}"
  delay: "{{ install_wait_delay }}"
  when: not operator_already_installed

# Step 3: Wait for CSV to be ready (applies to both new and existing installs)
- name: Get the CSV name
  ansible.builtin.set_fact:
    operator_csv: >-
      {{ existing_subscription.resources[0].status.currentCSV
         if operator_already_installed
         else subscription_info.resources[0].status.currentCSV }}

- name: Wait for ClusterServiceVersion to succeed
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    name: "{{ operator_csv }}"
    namespace: "{{ install_operator_namespace }}"
  register: csv_info
  until: >-
    csv_info.resources | length > 0 and
    csv_info.resources[0].status.phase is defined and
    csv_info.resources[0].status.phase == "Succeeded"
  retries: "{{ install_wait_retries }}"
  delay: "{{ install_wait_delay }}"

- name: Operator {{ install_operator_name }} is ready
  ansible.builtin.debug:
    msg: "Operator {{ install_operator_name }} ({{ operator_csv }}) is ready for use"
