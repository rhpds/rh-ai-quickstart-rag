---
# Simplified Showroom Deployment Role
# Deploys Showroom lab guide to OpenShift using Helm chart
#
# Required variables:
#   - showroom_guid: Unique identifier for this deployment
#   - showroom_deployer_domain: The cluster's apps domain (e.g., apps.cluster.example.com)
#   - showroom_content_git_repo: Git repository with Antora content
#
# Optional variables:
#   - showroom_user_data: Dictionary of data to pass to Antora templates

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - showroom_guid is defined and showroom_guid | length > 0
      - showroom_deployer_domain is defined and showroom_deployer_domain | length > 0
      - showroom_content_git_repo is defined and showroom_content_git_repo | length > 0
    fail_msg: "Required variables not defined: showroom_guid, showroom_deployer_domain, showroom_content_git_repo"
    quiet: true

- name: Set showroom namespace
  ansible.builtin.set_fact:
    _showroom_namespace: "{{ showroom_namespace | default('showroom-' ~ showroom_guid) }}"

- name: Display showroom deployment information
  ansible.builtin.debug:
    msg:
      - "=== Deploying Showroom ==="
      - "Namespace: {{ _showroom_namespace }}"
      - "Content Repo: {{ showroom_content_git_repo }}"
      - "Domain: {{ showroom_deployer_domain }}"

- name: Create showroom namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ _showroom_namespace }}"
        labels:
          guid: "{{ showroom_guid }}"
          app.kubernetes.io/name: showroom
          demo.redhat.com/application: showroom

- name: Prepare user_data for Helm values
  ansible.builtin.set_fact:
    _showroom_vars: "{{ {'guid': showroom_guid} | combine(showroom_user_data | default({})) }}"

- name: Render showroom Helm chart
  kubernetes.core.helm_template:
    chart_repo_url: "{{ showroom_chart_package_url }}"
    chart_ref: "{{ showroom_deployer_chart_name }}"
    chart_version: "{{ showroom_deployer_chart_version }}"
    release_name: "{{ showroom_name }}"
    release_namespace: "{{ _showroom_namespace }}"
    release_values:
      content:
        image: "{{ showroom_content_image }}"
        user_data: "{{ _showroom_vars | to_nice_yaml(width=1337, default_style='\"') }}"
        repoUrl: "{{ showroom_content_git_repo }}"
        repoRef: "{{ showroom_content_git_repo_ref }}"
        antoraPlaybook: "{{ showroom_content_antora_playbook }}"
      guid: "{{ showroom_guid }}"
      deployer:
        domain: "{{ showroom_deployer_domain }}"
      terminal:
        setup: "{{ (showroom_terminal_type == 'showroom') | string | lower }}"
        image: "{{ showroom_terminal_image }}"
        resources:
          requests:
            cpu: "{{ showroom_terminal_requests_cpu }}"
            memory: "{{ showroom_terminal_requests_memory }}"
          limits:
            cpu: "{{ showroom_terminal_limits_cpu }}"
            memory: "{{ showroom_terminal_limits_memory }}"
      wetty:
        setup: "false"
      novnc:
        setup: "false"
  register: r_helm_templates

- name: Deploy showroom manifests to OpenShift
  kubernetes.core.k8s:
    state: present
    definition: "{{ r_helm_templates.stdout | from_yaml_all }}"
  register: r_deploy_manifests
  retries: 10
  delay: 5
  until: r_deploy_manifests is not failed

- name: Wait for showroom pod to be created
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ _showroom_namespace }}"
    label_selectors:
      - app.kubernetes.io/name={{ showroom_name }}
  register: r_showroom_pod
  retries: 30
  delay: 5
  until: r_showroom_pod.resources | length > 0

- name: Wait for showroom pod to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ _showroom_namespace }}"
    name: "{{ r_showroom_pod.resources[0].metadata.name }}"
  register: r_pod_status
  retries: 60
  delay: 10
  until:
    - r_pod_status.resources | length > 0
    - r_pod_status.resources[0].status.phase == 'Running'
    - r_pod_status.resources[0].status.containerStatuses is defined
    - r_pod_status.resources[0].status.containerStatuses | selectattr('ready', 'equalto', true) | list | length == r_pod_status.resources[0].status.containerStatuses | length

- name: Get showroom route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: "{{ showroom_name }}"
    namespace: "{{ _showroom_namespace }}"
  register: r_showroom_route
  retries: 10
  delay: 5
  until: r_showroom_route.resources | length > 0

- name: Set showroom URL fact
  ansible.builtin.set_fact:
    showroom_url: "https://{{ r_showroom_route.resources[0].spec.host }}"

- name: Display showroom deployment complete
  ansible.builtin.debug:
    msg:
      - "=== Showroom Deployment Complete ==="
      - "URL: {{ showroom_url }}"
      - "Namespace: {{ _showroom_namespace }}"
